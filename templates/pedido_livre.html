{% extends "base.html" %}
{% block content %}

<h2>Nova Compra (InclusÃ£o Livre)</h2>

<form method="POST" id="formPedidoLivre">

    <!-- ================= CLIENTE ================= -->
    <label>Cliente</label>
    <select name="cliente_id" class="form-control mb-3" required>
        <option value="">Selecione</option>
        {% for c in clientes %}
            <option value="{{ c.id }}">{{ c.nome }}</option>
        {% endfor %}
    </select>

    <!-- ================= PRODUTOS ================= -->
    <h4>Produtos</h4>

    <button type="button" class="btn btn-primary mb-3" onclick="adicionarLinha()">
        âž• Adicionar Produto
    </button>

    <table class="table" id="tabelaProdutos">
        <thead>
            <tr>
                <th>Produto</th>
                <th style="width:120px">Qtd</th>
                <th style="width:140px">Valor Unit.</th>
                <th style="width:140px">Subtotal</th>
                <th style="width:60px"></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- ================= TOTAIS ================= -->
    <h5>Total Produtos: R$ <span id="totalBruto">0.00</span></h5>

    <hr>

    <!-- ================= DESCONTO ================= -->
    <h5>ðŸ”¥ Desconto (opcional)</h5>

    <div class="row mb-3" style="max-width:600px">
        <div class="col-md-4">
            <label>Tipo</label>
            <select name="desconto_tipo" id="tipoDesconto" class="form-control">
                <option value="">Sem desconto</option>
                <option value="valor">Valor (R$)</option>
                <option value="percentual">Percentual (%)</option>
            </select>
        </div>

        <div class="col-md-4 d-none" id="campoValor">
            <label>Desconto (R$)</label>
            <input type="number" step="0.01" min="0"
                   name="desconto_valor" id="descontoValor"
                   class="form-control" value="0">
        </div>

        <div class="col-md-4 d-none" id="campoPercentual">
            <label>Desconto (%)</label>
            <input type="number" step="0.01" min="0" max="100"
                   name="desconto_valor" id="descontoPercentual"
                   class="form-control" value="0">
        </div>
    </div>

    <h4>Total Final: R$ <span id="totalFinal">0.00</span></h4>

    <hr>

    <!-- ================= PAGAMENTO ================= -->
    <label>Pagamento</label>
    <select name="pagamento" class="form-control mb-4" required>
        <option value="PIX">PIX</option>
        <option value="CartÃ£o">CartÃ£o</option>
    </select>

    <button class="btn btn-success">Salvar Pedido</button>
    <a href="{{ url_for('pedidos.pedidos_lista') }}" class="btn btn-secondary">
        Voltar
    </a>
</form>

<!-- ================= JAVASCRIPT ================= -->
<script>
function adicionarLinha() {
    const tbody = document.querySelector("#tabelaProdutos tbody");
    const tr = document.createElement("tr");

    tr.innerHTML = `
        <td><input type="text" name="produto_nome[]" class="form-control" required></td>
        <td><input type="number" name="produto_qtd[]" class="form-control qtd" min="1" value="1"></td>
        <td><input type="number" name="produto_preco[]" class="form-control preco" step="0.01" min="0"></td>
        <td><input type="text" class="form-control subtotal" readonly></td>
        <td><button type="button" class="btn btn-danger btnRemover">X</button></td>
    `;

    tbody.appendChild(tr);
    atualizarTotais();
}

function atualizarTotais() {
    let totalBruto = 0;

    document.querySelectorAll("#tabelaProdutos tbody tr").forEach(row => {
        const qtd = parseFloat(row.querySelector(".qtd").value) || 0;
        const preco = parseFloat(row.querySelector(".preco").value) || 0;
        const subtotal = qtd * preco;

        row.querySelector(".subtotal").value = subtotal.toFixed(2);
        totalBruto += subtotal;
    });

    let desconto = 0;
    const tipo = tipoDesconto.value;

    if (tipo === "valor") {
        desconto = parseFloat(descontoValor.value) || 0;
    }

    if (tipo === "percentual") {
        desconto = totalBruto * ((parseFloat(descontoPercentual.value) || 0) / 100);
    }

    desconto = Math.min(desconto, totalBruto);

    document.getElementById("totalBruto").innerText = totalBruto.toFixed(2);
    document.getElementById("totalFinal").innerText = (totalBruto - desconto).toFixed(2);
}

// ================= EVENTOS =================
document.addEventListener("input", e => {
    if (
        e.target.classList.contains("qtd") ||
        e.target.classList.contains("preco") ||
        e.target.id === "descontoValor" ||
        e.target.id === "descontoPercentual"
    ) {
        atualizarTotais();
    }
});

document.addEventListener("click", e => {
    if (e.target.classList.contains("btnRemover")) {
        e.target.closest("tr").remove();
        atualizarTotais();
    }
});

tipoDesconto.addEventListener("change", () => {
    campoValor.classList.toggle("d-none", tipoDesconto.value !== "valor");
    campoPercentual.classList.toggle("d-none", tipoDesconto.value !== "percentual");

    descontoValor.value = 0;
    descontoPercentual.value = 0;
    atualizarTotais();
});
</script>

{% endblock %}
{% extends "base.html" %}
{% block content %}

<h2>Editar Pedido Livre
    <small class="text-muted">– Pedido nº {{ pedido.id }}</small>
</h2>

<form method="POST" id="formPedido">

<!-- ================= CLIENTE ================= -->
<label>Cliente</label>
<select name="cliente_id" class="form-control mb-3" required>
    <option value="">Selecione</option>
    {% for c in clientes %}
        <option value="{{ c.id }}"
            {% if pedido.cliente_id == c.id %}selected{% endif %}>
            {{ c.nome }}
        </option>
    {% endfor %}
</select>

<!-- ================= PRODUTOS ================= -->
<h4>Produtos</h4>

<table class="table" id="tabelaProdutos">
    <thead>
        <tr>
            <th>Produto</th>
            <th style="width:100px">Qtd</th>
            <th style="width:130px">Valor Unit.</th>
            <th style="width:130px">Subtotal</th>
            <th style="width:60px"></th>
        </tr>
    </thead>
    <tbody>
        {% for pr in produtos %}
        {% set pid = pr.id if pr.id is not none else loop.index0 %}
        <tr data-id="{{ pid }}">
            <td>
                {{ pr.nome }}
                <input type="hidden" name="produto_nome[]" value="{{ pr.nome }}">
            </td>
            <td>
                <input type="number" min="1" class="form-control qtd"
                       name="produto_qtd[]" value="{{ pr.quantidade }}">
            </td>
            <td>
                <input type="number" step="0.01" min="0" class="form-control preco"
                       name="produto_preco[]" value="{{ '%.2f'|format(pr.preco) }}">
            </td>
            <td>
                <input type="text" class="form-control subtotal" readonly>
            </td>
            <td>
                <button type="button" class="btn btn-danger btnRemover">X</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ================= TOTAIS ================= -->
<h5>Total Bruto: R$ <span id="totalGeral">0.00</span></h5>
<hr>

<!-- ================= DESCONTO ================= -->
<h5>Desconto</h5>
<div class="row mb-3" style="max-width:600px">
    <div class="col-md-4">
        <label>Valor (R$)</label>
        <input type="number" step="0.01" min="0"
               id="descontoValor" class="form-control"
               value="{{ desconto_valor }}">
    </div>
</div>

<input type="hidden" name="desconto" id="descontoFinal" value="{{ desconto_valor }}">
<h4>Total Final: R$ <span id="totalFinal">0.00</span></h4>

<!-- ================= PAGAMENTO ================= -->
<label>Pagamento</label>
<select name="pagamento" class="form-control mb-4" required>
    <option value="PIX" {% if pedido.pagamento=='PIX' %}selected{% endif %}>PIX</option>
    <option value="Cartão" {% if pedido.pagamento=='Cartão' %}selected{% endif %}>Cartão</option>
</select>

<button class="btn btn-success">Salvar Pedido</button>
<a href="{{ url_for('pedidos.pedidos_lista') }}" class="btn btn-secondary">Voltar</a>
</form>

<script>
function atualizarTotais() {
    let total = 0;
    document.querySelectorAll('#tabelaProdutos tbody tr').forEach(r => {
        const qtd = parseFloat(r.querySelector('.qtd').value) || 0;
        const preco = parseFloat(r.querySelector('.preco').value) || 0;
        const sub = qtd * preco;
        r.querySelector('.subtotal').value = sub.toFixed(2);
        total += sub;
    });

    let desconto = parseFloat(document.getElementById('descontoValor').value) || 0;
    desconto = Math.min(desconto, total);

    document.getElementById('descontoFinal').value = desconto.toFixed(2);
    document.getElementById('totalGeral').innerText = total.toFixed(2);
    document.getElementById('totalFinal').innerText = (total - desconto).toFixed(2);
}

// Atualiza totais ao alterar quantidade, preço ou desconto
document.addEventListener('input', e => {
    if (e.target.classList.contains('qtd') || e.target.classList.contains('preco') || e.target.id==='descontoValor')
        atualizarTotais();
});

// Remove produto da tabela
document.addEventListener('click', e => {
    if (e.target.classList.contains('btnRemover')) {
        e.target.closest('tr').remove();
        atualizarTotais();
    }
});

// Inicializa totais ao carregar a página
document.addEventListener('DOMContentLoaded', atualizarTotais);
</script>

{% endblock %}
